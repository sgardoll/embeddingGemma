---
phase: 00-build-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [lib/custom_code/actions/initialize_gemma.dart, lib/custom_code/gemma_embedder_wrapper.dart, lib/custom_code/actions/download_embedding_model.dart]
autonomous: true
---

<objective>
Fix flutter_gemma API compatibility issues causing build failure.

Purpose: The project uses flutter_gemma 0.12.2 but the code references an older API that no longer exists. The Modern API requires:
1. Import from `package:flutter_gemma/core/api/flutter_gemma.dart` for `FlutterGemma` class
2. Import from `package:flutter_gemma/flutter_gemma.dart` for types like `EmbeddingModel`, `PreferredBackend`
3. Correct method signatures and patterns

Output: Working build on iOS simulator with no Dart compilation errors.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
**Root Cause Analysis:**
Build errors from Xcode output:
- `lib/custom_code/actions/initialize_gemma.dart:27:9: Error: Undefined name 'FlutterGemma'.`
- `lib/custom_code/gemma_embedder_wrapper.dart:12:3: Error: Type 'EmbeddingModel' not found.`
- `lib/custom_code/gemma_embedder_wrapper.dart:23:33: Error: The getter 'FlutterGemma' isn't defined`
- `lib/custom_code/gemma_embedder_wrapper.dart:24:27: Error: The getter 'PreferredBackend' isn't defined`
- `lib/custom_code/actions/download_embedding_model.dart:32:11: Error: Undefined name 'FlutterGemma'.`

**flutter_gemma 0.12.2 Modern API (from official docs):**

1. **Initialization:**
```dart
import 'package:flutter_gemma/core/api/flutter_gemma.dart';

FlutterGemma.initialize(
  huggingFaceToken: const String.fromEnvironment('HUGGINGFACE_TOKEN'), // optional
  maxDownloadRetries: 10, // optional
);
```

2. **Install Embedding Model:**
```dart
await FlutterGemma.installEmbedder()
  .modelFromNetwork('https://example.com/model.tflite', token: 'hf_...')
  .tokenizerFromNetwork('https://example.com/tokenizer.model', token: 'hf_...')
  .withModelProgress((p) => print('Model: $p%'))
  .withTokenizerProgress((p) => print('Tokenizer: $p%'))
  .install();
```

3. **Get Active Embedder:**
```dart
final embeddingModel = await FlutterGemma.getActiveEmbedder(
  preferredBackend: PreferredBackend.cpu,
);
final embedding = await embeddingModel.generateEmbedding('text');
```

4. **Types like EmbeddingModel, PreferredBackend:**
```dart
import 'package:flutter_gemma/flutter_gemma.dart'; // exports EmbeddingModel, PreferredBackend
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix initialize_gemma.dart imports and API usage</name>
  <files>lib/custom_code/actions/initialize_gemma.dart</files>
  <action>
  Update the import and method call:
  
  1. Change import from `package:flutter_gemma/flutter_gemma.dart` to:
     ```dart
     import 'package:flutter_gemma/core/api/flutter_gemma.dart';
     ```
  
  2. Update the `initializeGemma()` function to call the new async initialization:
     ```dart
     Future initializeGemma() async {
       await FlutterGemma.initialize();
     }
     ```
     
  Note: The Modern API's `initialize()` is now async and takes optional parameters. With no required parameters, the simplest fix is to await it.
  
  IMPORTANT: Do NOT modify or remove the FlutterFlow header block (lines with "DO NOT REMOVE OR MODIFY THE CODE ABOVE!").
  </action>
  <verify>Run `flutter analyze lib/custom_code/actions/initialize_gemma.dart` - no errors</verify>
  <done>initialize_gemma.dart compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Fix gemma_embedder_wrapper.dart imports and API usage</name>
  <files>lib/custom_code/gemma_embedder_wrapper.dart</files>
  <action>
  Update imports and type references:
  
  1. Add both imports needed:
     ```dart
     import 'package:flutter_gemma/flutter_gemma.dart'; // For EmbeddingModel, PreferredBackend
     import 'package:flutter_gemma/core/api/flutter_gemma.dart'; // For FlutterGemma static class
     ```
  
  2. The code pattern is mostly correct, but the static method call needs to use the Modern API:
     - `FlutterGemma.getActiveEmbedder(preferredBackend: PreferredBackend.cpu)` is correct in Modern API
     - `EmbeddingModel` type is correct
     - `PreferredBackend.cpu` is correct
  
  The issue is purely an import problem - the types exist but aren't imported correctly.
  </action>
  <verify>Run `flutter analyze lib/custom_code/gemma_embedder_wrapper.dart` - no errors</verify>
  <done>gemma_embedder_wrapper.dart compiles without errors, EmbeddingModel and PreferredBackend types resolve correctly</done>
</task>

<task type="auto">
  <name>Task 3: Fix download_embedding_model.dart imports</name>
  <files>lib/custom_code/actions/download_embedding_model.dart</files>
  <action>
  Update the import:
  
  1. Change import from `package:flutter_gemma/flutter_gemma.dart` to:
     ```dart
     import 'package:flutter_gemma/core/api/flutter_gemma.dart';
     ```
  
  The existing code pattern is correct for Modern API:
  ```dart
  await FlutterGemma.installEmbedder()
      .modelFromNetwork(modelUrl)
      .tokenizerFromNetwork(tokenizerUrl)
      .install();
  ```
  
  IMPORTANT: Do NOT modify or remove the FlutterFlow header block (lines with "DO NOT REMOVE OR MODIFY THE CODE ABOVE!").
  </action>
  <verify>Run `flutter analyze lib/custom_code/actions/download_embedding_model.dart` - no errors</verify>
  <done>download_embedding_model.dart compiles without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `flutter analyze` passes on all modified files
- [ ] `flutter build ios --simulator` succeeds without the original errors
- [ ] No new errors introduced
</verification>

<success_criteria>
- All three files compile without errors
- iOS simulator build succeeds
- FlutterFlow header blocks remain intact
- Embedding functionality API calls are correct for flutter_gemma 0.12.2
</success_criteria>

<output>
After completion, create `.planning/phases/00-build-fix/00-01-SUMMARY.md`
</output>
